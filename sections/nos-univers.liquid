{%- comment -%}
  NOS UNIVERS - Collections dynamiques Shopify
  Affiche automatiquement les VRAIES collections du store
  Layout adaptatif selon le nombre de collections
{%- endcomment -%}

{%- comment -%} Filtrer les collections système et compter {%- endcomment -%}
{%- assign filtered_collections = collections | where: 'all_products_count', '>' | where_exp: 'c', 'c.handle != "all" and c.handle != "frontpage"' -%}

{%- comment -%} Fallback : si le filtre complexe ne marche pas, on boucle manuellement {%- endcomment -%}
{%- assign collection_count = 0 -%}
{%- assign valid_collections = '' -%}
{%- for collection in collections -%}
  {%- unless collection.handle == 'all' or collection.handle == 'frontpage' -%}
    {%- assign collection_count = collection_count | plus: 1 -%}
  {%- endunless -%}
{%- endfor -%}

{%- comment -%} Déterminer la classe de layout {%- endcomment -%}
{%- case collection_count -%}
  {%- when 1 -%}
    {%- assign layout_class = 'nos-univers__grid--single' -%}
  {%- when 2 -%}
    {%- assign layout_class = 'nos-univers__grid--duo' -%}
  {%- when 3 -%}
    {%- assign layout_class = 'nos-univers__grid--trio' -%}
  {%- else -%}
    {%- assign layout_class = 'nos-univers__grid--quad' -%}
{%- endcase -%}

{%- if collection_count > 0 -%}
<section class="section section--lg nos-univers">
  <div class="container">
    <header class="nos-univers__header reveal">
      {%- if section.settings.subtitle != blank -%}
        <p class="subtitle">{{ section.settings.subtitle }}</p>
      {%- endif -%}
      <h2>{{ section.settings.title }}</h2>
    </header>

    <div class="nos-univers__grid {{ layout_class }}">
      {%- assign index = 0 -%}
      {%- for collection in collections -%}
        {%- unless collection.handle == 'all' or collection.handle == 'frontpage' -%}
          {%- assign index = index | plus: 1 -%}

          <a href="{{ collection.url }}" class="univers-card reveal" style="--delay: {{ index | times: 0.1 }}s;">
            <div class="univers-card__media">
              {%- if collection.image -%}
                <img
                  src="{{ collection.image | image_url: width: 800 }}"
                  srcset="
                    {{ collection.image | image_url: width: 400 }} 400w,
                    {{ collection.image | image_url: width: 600 }} 600w,
                    {{ collection.image | image_url: width: 800 }} 800w,
                    {{ collection.image | image_url: width: 1200 }} 1200w"
                  sizes="(max-width: 480px) 100vw, (max-width: 1024px) 50vw, 25vw"
                  alt="{{ collection.title | escape }}"
                  loading="lazy"
                  decoding="async"
                  class="univers-card__image"
                >
              {%- elsif collection.products.first.featured_image -%}
                {%- comment -%} Fallback : utiliser l'image du premier produit {%- endcomment -%}
                <img
                  src="{{ collection.products.first.featured_image | image_url: width: 800 }}"
                  srcset="
                    {{ collection.products.first.featured_image | image_url: width: 400 }} 400w,
                    {{ collection.products.first.featured_image | image_url: width: 600 }} 600w,
                    {{ collection.products.first.featured_image | image_url: width: 800 }} 800w,
                    {{ collection.products.first.featured_image | image_url: width: 1200 }} 1200w"
                  sizes="(max-width: 480px) 100vw, (max-width: 1024px) 50vw, 25vw"
                  alt="{{ collection.title | escape }}"
                  loading="lazy"
                  decoding="async"
                  class="univers-card__image"
                >
              {%- else -%}
                <div class="univers-card__image univers-card__image--placeholder"></div>
              {%- endif -%}
              <div class="univers-card__overlay"></div>
            </div>

            <div class="univers-card__content">
              <h3 class="univers-card__title">{{ collection.title }}</h3>
              {%- if section.settings.show_product_count -%}
                <span class="univers-card__count">{{ collection.all_products_count }} {% if collection.all_products_count == 1 %}pièce{% else %}pièces{% endif %}</span>
              {%- endif -%}
            </div>
          </a>

        {%- endunless -%}
      {%- endfor -%}
    </div>
  </div>
</section>
{%- endif -%}

{% schema %}
{
  "name": "Nos Univers",
  "settings": [
    {
      "type": "text",
      "id": "subtitle",
      "label": "Sous-titre",
      "default": "Créations"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Nos univers"
    },
    {
      "type": "checkbox",
      "id": "show_product_count",
      "label": "Afficher le nombre de produits",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Nos Univers"
    }
  ]
}
{% endschema %}
